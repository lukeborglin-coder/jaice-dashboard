# Content Analysis Tab Pack

This pack adds a **Content Analysis** tab to your existing app. It supports:
1) Upload a Discussion Guide (.docx) -> AI-assisted generation of a Content Analysis Excel (matches your template).
2) Upload the Content Analysis Excel -> Interactive, updatable Content Analysis page bound to a Project.

## Files
- backend/
  - routes/contentAnalysis.routes.mjs
  - services/caGenerator.service.mjs
  - services/caIngest.service.mjs
  - util/xlsxSchema.mjs
  - prompts/ca_from_dg_prompt.txt
- frontend/
  - components/ContentAnalysisTab.jsx
  - lib/parseCA.js
- templates/
  - CA_template_HCP.xlsx

## Quick Install
1. Copy **backend/** files into your server (Node 18+ ESM). Ensure these env vars exist:
   - OPENAI_API_KEY=...
   - FILES_DIR=./uploads
2. Mount the router in your `server.mjs`:
   ```js
   import contentAnalysisRouter from './backend/routes/contentAnalysis.routes.mjs';
   app.use('/api/ca', contentAnalysisRouter);
   ```
3. Copy **frontend/** files into your web app. Add `ContentAnalysisTab.jsx` to your router/tabs.
4. Provide the template at `/api/ca/template` (already wired).
5. Restart and test.

## API (Server)
- `POST /api/ca/generate`  (multipart: `dg` .docx)
  -> returns `{ fileId, downloadUrl }` (Excel generated by AI + rules).
- `POST /api/ca/upload`   (multipart: `file` .xlsx, fields: `projectId`)
  -> stores the CA file and returns parsed JSON.
- `GET  /api/ca/template` -> downloads blank CA template.
- `GET  /api/ca/:projectId` -> returns parsed CA JSON for a project.

## Frontend
Drop-in React tab with:
- Upload DG -> Generate Excel (download + attach to project)
- Upload CA -> Render interactive tables, filters, ranks
- Auto-recalc of Rank within UI mirrors Excel formulas

## Notes
- The AI step uses a structured prompt and your DG headings to map into sheets:
  * Demos
  * Background & SMA Management
  * Category Ranking
  * Category C / S (etc.)
- You can extend `xlsxSchema.mjs` to add/rename sheets or columns.

